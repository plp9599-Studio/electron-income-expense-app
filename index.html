<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Photo Studio Manager (Cloud Sync)</title>

<!-- ELECTRON CSP FIX: Explicitly allow necessary domains (Firebase, Google APIs) -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.firebaseio.com https://*.googleapis.com https://www.gstatic.com data:;">

<style>
   /* --- STYLING --- */
   :root {
            --bg-color: #0f172a;       
            --card-bg: #1e293b;        
            --text-primary: #f1f5f9;   
            --text-secondary: #94a3b8; 
            --accent-esewa: #62cC29;   
            --accent-cash: #fbbf24;    
            --accent-expense: #ef4444; 
            --accent-highlight: #38bdf8;
            --accent-golden: #FFD700; /* NEW: Golden bright color */
            --border-color: #334155;
            --border-radius: 12px;
            --font-main: system-ui, -apple-system, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }

        /* NAVIGATION: Added space for the new tab */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 25px; background: var(--card-bg); padding: 6px; border-radius: 50px; border: 1px solid var(--border-color); }
        .nav-btn { background: transparent; color: var(--text-secondary); border: none; padding: 10px 25px; border-radius: 40px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .nav-btn.active { background: var(--accent-highlight); color: #0f172a; box-shadow: 0 0 10px rgba(56, 189, 248, 0.4); }
        .view-section { width: 100%; max-width: 900px; display: none; }
        .view-section.active { display: block; }

        /* DASHBOARD */
        header { text-align: center; margin-bottom: 20px; }
        h2 { margin-bottom: 5px; font-weight: 700; letter-spacing: 0.5px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: var(--border-radius); text-align: center; border: 1px solid var(--border-color); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-card h4 { font-size: 0.75rem; text-transform: uppercase; margin-bottom: 10px; color: var(--text-secondary); letter-spacing: 1px; }
        .stat-card p { font-size: 1.2rem; font-weight: 700; }
        .val-prev { color: var(--text-secondary); }
        .val-income { color: var(--accent-esewa); } 
        .val-expense { color: var(--accent-expense); }
        .val-total { color: var(--accent-highlight); font-size: 1.4rem !important; }

        /* FORM */
        .form-container { background: var(--card-bg); padding: 30px; border-radius: var(--border-radius); margin-bottom: 30px; border: 1px solid var(--border-color); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .form-group { flex: 1; }
        label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-secondary); font-weight: 500; }
        
        /* Standard Date Input Styling */
        input, select { width: 100%; padding: 14px; background-color: var(--bg-color); border: 1px solid var(--border-color); color: white; border-radius: 8px; font-size: 1rem; outline: none; transition: border-color 0.2s; }
        input:focus, select:focus { border-color: var(--accent-highlight); }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

        .btn { cursor: pointer; background-color: var(--accent-highlight); color: #0f172a; border: 0; display: block; width: 100%; padding: 14px; font-size: 1rem; font-weight: 700; border-radius: 8px; transition: transform 0.1s, opacity 0.2s, background-color 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:active { transform: translateY(1px); }

        /* Update Tab Specific Styling */
        .update-card {
            background: var(--card-bg); 
            padding: 40px; 
            border-radius: var(--border-radius); 
            border: 1px solid var(--border-color);
            text-align: center;
        }
        .update-status {
            font-size: 1.1rem;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
        }
        .status-ok { background: rgba(98, 204, 41, 0.2); color: var(--accent-esewa); }
        .status-update { background: rgba(56, 189, 248, 0.2); color: var(--accent-highlight); }
        .status-error { background: rgba(239, 68, 68, 0.2); color: var(--accent-expense); }
        .update-progress { margin: 15px 0; }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--bg-color);
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-bar div {
            height: 100%;
            background: var(--accent-highlight);
            transition: width 0.3s;
        }
        
        /* --- CRITICAL FIX: Force Modal to be hidden by default --- */
        .modal {
            display: none !important; 
            position: fixed; 
            z-index: 100; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%;
            background-color: rgba(0,0,0,0.85); 
            backdrop-filter: blur(4px); 
            align-items: center; 
            justify-content: center;
        }
        
        /* --- PRINT STYLES FOR MAIN REPORT VIEW --- */
        @media print {
            /* Hide UI elements */
            .nav-tabs, .form-container, .btn, .close-modal, .no-print, #loading-overlay, .modal { display: none !important; }
            
            /* Show only the Reports view when printing the report */
            body.printing-report #reports-view {
                display: block !important;
                padding: 0 !important;
                width: 100%;
                max-width: none;
            }
            body.printing-report .view-section:not(#reports-view) {
                display: none !important;
            }
            body.printing-report, body.printing-report header, body.printing-report table {
                background: white !important;
                color: black !important;
            }
            body.printing-report .report-table {
                border: 1px solid #000;
                color: black !important;
            }
            body.printing-report .report-table th, 
            body.printing-report .report-table td {
                border-bottom: 1px solid #ccc;
                color: black !important;
            }
            body.printing-report .report-table th {
                background: #eee !important;
            }
        }
        
        /* Contact Tab Styling (UPDATED) */
        .contact-details {
            background: var(--card-bg); 
            padding: 30px; 
            border-radius: var(--border-radius); 
            border: 1px solid var(--border-color);
            max-width: 500px;
            margin: 0 auto;
        }
        .contact-details h3 {
            color: var(--accent-golden); /* GOLDEN BRIGHT FONT */
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        .contact-item-row {
            background: #000000; /* BLACK BACKGROUND */
            color: var(--accent-golden); /* GOLDEN BRIGHT FONT */
            display: flex;
            align-items: center;
            padding: 15px 20px;
            font-size: 1.05rem;
            border-radius: 8px; /* ROUNDED CORNERS */
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }
        .contact-item-row span:first-child {
            color: var(--text-secondary);
            width: 100px;
            font-weight: 500;
        }
        .contact-item-row a {
            color: var(--accent-golden);
            text-decoration: none;
            word-break: break-all;
        }
  </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="color:var(--text-secondary)">Syncing with Cloud...</div>
</div>

<nav class="nav-tabs no-print">
<button class="nav-btn active" onclick="switchTab('dashboard')">Dashboard</button>
<button class="nav-btn" onclick="switchTab('reports')">Past Reports</button>
<button class="nav-btn" onclick="switchTab('update')">Updates</button>
<button class="nav-btn" onclick="switchTab('contact')">Contact</button>
</nav>

<!-- DASHBOARD -->
<div class="view-section active" id="dashboard-view">
<header>
<h2>PHOTO STUDIO MANAGER</h2>
<p style="color:var(--text-secondary);">Cloud Synced ‚Ä¢ Standard Date</p>
<br/>
<div class="dashboard-grid">
<div class="stat-card"><h4>Previous Bal</h4><p class="val-prev" id="prev-balance">Rs. 0.00</p></div>
<div class="stat-card"><h4>Income (Selected Date)</h4><p class="val-income" id="today-income">+Rs. 0.00</p></div>
<div class="stat-card"><h4>Expense (Selected Date)</h4><p class="val-expense" id="today-expense">-Rs. 0.00</p></div>
<div class="stat-card" style="border: 1px solid var(--accent-highlight);"><h4>Net Cash Hand</h4><p class="val-total" id="total-balance">Rs. 0.00</p></div>
</div>
</header>
<section class="form-container">
<form id="form">
<div class="form-row">
<div class="form-group">
    <label>Date</label>
    <input id="date" type="date" required />
</div>
<div class="form-group"><label>Type</label><select id="type"><option value="income">Income (Sale)</option><option value="expense">Expense (Bill)</option></select></div>
<div class="form-group"><label>Payment Method</label><select id="method"><option value="cash">Cash</option><option value="esewa">Esewa</option></select></div>
</div>
<div class="form-row">
<div class="form-group" style="flex: 2;"><label>Description</label><input id="text" placeholder="e.g. Wedding Print, Electricity Bill..." required="" type="text"/></div>
<div class="form-group"><label>Amount (Rs.)</label><input id="amount" placeholder="0.00" required="" type="number"/></div>
</div>
<button id="submit-btn" class="btn">Add Transaction</button>
</form>
</section>
<div style="text-align:center; color: var(--accent-esewa); font-size: 0.8rem; margin-top:10px;">üü¢ Online: Changes sync automatically to all devices.</div>
</div>

<!-- REPORTS -->
<div class="view-section" id="reports-view">
    <header>
        <h2 style="color: var(--accent-expense);">DAILY LEDGER FIX.2</h2>
        <p style="color:var(--text-secondary);">Daily Totals and Net Flow by Payment Method</p>
    </header>
    <br/>
    <div style="overflow-x:auto;">
        <table class="report-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th style="color:var(--accent-esewa);">Income Total</th>
                    <th style="color:var(--accent-expense);">Expense Total</th>
                    <th style="color:var(--accent-cash);">Cash Net Flow</th>
                    <th style="color:var(--accent-highlight);">Net Daily Balance</th>
                </tr>
            </thead>
            <tbody id="reports-list"></tbody>
        </table>
    </div>
    <div style="text-align:center; margin-top: 30px;" class="no-print">
        <button class="btn" style="width: 250px;" onclick="window.printReportsView()">üñ®Ô∏è Print Full Ledger</button>
    </div>
</div>

<!-- UPDATE TAB (NEW) -->
<div class="view-section" id="update-view">
    <header><h2>APPLICATION UPDATES</h2><p style="color:var(--text-secondary);">Manage app version and availability.</p></header>
    <section class="update-card">
        <h3>Current Version: <span id="app-version">Loading...</span></h3>
        <hr style="border-color:var(--border-color); margin: 20px 0;">

        <div id="update-status" class="update-status status-ok">Checking for updates...</div>
        
        <div id="update-progress-container" class="update-progress" style="display:none;">
            <p id="download-info" style="color:var(--text-secondary); margin-bottom: 5px;">Downloading...</p>
            <div class="progress-bar"><div id="download-progress" style="width: 0%;"></div></div>
        </div>

        <button id="update-check-btn" class="btn" style="width: 250px; margin-top: 30px;" onclick="window.checkUpdate()">Check for New Updates</button>
        <button id="update-install-btn" class="btn status-update" style="width: 250px; margin-top: 15px; display:none;" onclick="window.quitAndInstall()">Restart and Install Update</button>
    </section>
</div>

<!-- CONTACT TAB (NEW) -->
<div class="view-section" id="contact-view">
    <header><h2>CONTACT INFORMATION</h2><p style="color:var(--text-secondary);">Support and business details.</p></header>
    <div class="contact-details">
        <h3>Business Contact</h3>
        
        <!-- Phone Row -->
        <div class="contact-item-row">
            <span>Phone:</span>
            <a href="tel:+9779847309293">+977 9847309293</a>
        </div>
        
        <!-- Email Row -->
        <div class="contact-item-row">
            <span>Email:</span>
            <a href="mailto:sbashyal26@gmail.com">sbashyal26@gmail.com</a>
        </div>
        
        <!-- Location Row (Single/Two lines max) -->
        <div class="contact-item-row">
            <span>Location:</span>
            <span>Butwal 08, milanchowk rupandehi</span>
        </div>
    </div>
</div>

<!-- MODAL (The content is only here, hidden by default CSS) -->
<div class="modal" id="daily-modal">
    <div class="modal-content"><span class="close-modal no-print" onclick="closeModal()">√ó</span>
    <div class="modal-header">
        <h4 id="modal-date-title" style="color:var(--text-secondary); margin-top:5px;">Date: ...</h4>
    </div>
    <table class="statement-table"><thead><tr><th>Description</th><th style="width:100px;">Method</th><th style="text-align:right;">Amount</th><th class="no-print" style="width:60px;"></th></tr></thead><tbody id="modal-transactions-body"></tbody></table>
    <div class="summary-box"><span>Cash: <b id="modal-cash-total" style="color:var(--accent-cash)">Rs. 0.00</b></span><span>Esewa: <b id="modal-esewa-total" style="color:var(--accent-esewa)">Rs. 0.00</b></span></div>
    <div style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top:15px; display:flex; justify-content:space-between; font-weight:bold; font-size:1.2rem;"><span>Total Net:</span><span class="val-total" id="modal-total">Rs. 0.00</span></div>
    <br/><!-- Removed modal print button --></div> 
</div>

<!-- GLOBAL UI SCRIPT -->
<script>
// --- GLOBAL VARIABLES ---
// NOTE: Must update views object to include the new tab!
window.transactions = []; 

const views = { dashboard: document.getElementById('dashboard-view'), reports: document.getElementById('reports-view'), update: document.getElementById('update-view'), contact: document.getElementById('contact-view') };
const navBtns = document.querySelectorAll('.nav-btn');
const modal = document.getElementById('daily-modal');
const dateInput = document.getElementById('date');
const totalBalanceEl = document.getElementById('total-balance');
const prevBalanceEl = document.getElementById('prev-balance');
const todayIncomeEl = document.getElementById('today-income');
const todayExpenseEl = document.getElementById('today-expense');

// Update Tab Elements
const statusEl = document.getElementById('update-status');
const versionEl = document.getElementById('app-version');
const installBtn = document.getElementById('update-install-btn');
const checkBtn = document.getElementById('update-check-btn');
const progressContainer = document.getElementById('update-progress-container');
const progressBar = document.getElementById('download-progress');
const downloadInfo = document.getElementById('download-info');

// Set Default Date to Today (English)
dateInput.valueAsDate = new Date();

// --- ELECTRON PRINT LOGIC FOR MAIN REPORT VIEW ---
window.printReportsView = () => {
    // Add temporary class to signal CSS to show only report view
    document.body.classList.add('printing-report');
    window.print();
    // Use a small delay to allow print dialog to initialize before removing class
    setTimeout(() => {
        document.body.classList.remove('printing-report');
    }, 100);
}


// --- INITIAL ELECTRON COMMUNICATION SETUP ---
if (window.electronAPI) {
    // Get version immediately
    versionEl.innerText = window.electronAPI.getAppVersion();
    
    // Listen for status updates from main.js
    window.electronAPI.onUpdateStatus((event, status) => {
        statusEl.className = 'update-status status-ok';
        checkBtn.style.display = 'block';
        installBtn.style.display = 'none';
        progressContainer.style.display = 'none';

        if (status.type === 'checking') {
            statusEl.innerText = 'Checking for updates...';
        } else if (status.type === 'available') {
            statusEl.innerText = `Update available: v${status.info.version}. Click Download to proceed.`;
            statusEl.classList.remove('status-ok');
            statusEl.classList.add('status-update');
            checkBtn.innerText = 'Download Update Now';
            checkBtn.onclick = window.downloadUpdate;

        } else if (status.type === 'not-available') {
            statusEl.innerText = 'App is up to date!';
            statusEl.classList.add('status-ok');
            checkBtn.innerText = 'Check for New Updates';
            checkBtn.onclick = window.checkUpdate;

        } else if (status.type === 'downloading') {
            statusEl.innerText = `Downloading update... (${status.progress}% complete)`;
            statusEl.classList.remove('status-ok');
            statusEl.classList.add('status-update');
            checkBtn.style.display = 'none';
            progressContainer.style.display = 'block';
            progressBar.style.width = `${status.progress}%`;
            downloadInfo.innerText = `Downloading v${status.info.version} (${status.progress.toFixed(1)}%)`;

        } else if (status.type === 'downloaded') {
            statusEl.innerText = `Update downloaded! Restart to install v${status.info.version}.`;
            statusEl.classList.remove('status-update');
            statusEl.classList.add('status-update');
            installBtn.style.display = 'block';
            checkBtn.style.display = 'none';
            progressContainer.style.display = 'none';

        } else if (status.type === 'error') {
            statusEl.innerText = `Error: Could not check for updates.`;
            statusEl.classList.add('status-error');
        }
    });
} else {
    // Fallback if not running in Electron
    versionEl.innerText = 'Web Mode / v1.0.0 (No Auto-Updates)';
    statusEl.innerText = 'Application updates managed externally.';
    checkBtn.style.display = 'none';
}


// --- EXPORTED ELECTRON ACTIONS (Called by UI buttons) ---
window.checkUpdate = () => {
    if (window.electronAPI) {
        window.electronAPI.checkUpdate();
        statusEl.innerText = 'Checking for updates...';
        checkBtn.innerText = 'Checking...';
        checkBtn.disabled = true;
        setTimeout(() => checkBtn.disabled = false, 5000);
    }
}
window.downloadUpdate = () => {
    if (window.electronAPI) {
        window.electronAPI.downloadUpdate();
    }
}
window.quitAndInstall = () => {
    if (window.electronAPI) {
        window.electronAPI.quitAndInstall();
    }
}

// --- STANDARD UI FUNCTIONS ---
window.switchTab = (tabName, evt) => {
    Object.keys(views).forEach(key => views[key].classList.remove('active'));
    views[tabName].classList.add('active');
    navBtns.forEach(btn => btn.classList.remove('active'));
    if (evt && evt.currentTarget) evt.currentTarget.classList.add('active');
    if(tabName === 'reports') window.renderReports();
}

window.updateDashboard = () => {
    const targetDate = document.getElementById('date').value;
    let total = 0, prevTotal = 0, todayInc = 0, todayExp = 0;

    window.transactions.forEach(t => {
        const val = t.type === 'expense' ? -t.amount : t.amount;
        total += val; 
        if (t.date === targetDate) {
            if (t.type === 'income') todayInc += t.amount;
            if (t.type === 'expense') todayExp += t.amount;
        } else if (t.date < targetDate) {
            prevTotal += val;
        }
    });

    totalBalanceEl.innerText = `Rs. ${total.toFixed(2)}`;
    prevBalanceEl.innerText = `Rs. ${prevTotal.toFixed(2)}`;
    todayIncomeEl.innerText = `+Rs. ${todayInc.toFixed(2)}`;
    todayExpenseEl.innerText = `-Rs. ${todayExp.toFixed(2)}`;
}

window.renderReports = () => {
    const list = document.getElementById('reports-list');
    list.innerHTML = '';
    const groups = {};

    window.transactions.forEach(t => {
        if(!groups[t.date]) groups[t.date] = { income: 0, expense: 0, cashNet: 0, esewaNet: 0, transactions: [] };
        const val = t.type === 'expense' ? -t.amount : t.amount;
        const method = t.method || 'cash';
        
        // --- FIX: Correctly calculate totals and net flow ---
        // These totals are used in the new reports table structure
        if(t.type === 'income') {
            groups[t.date].income += t.amount;
            if(method === 'esewa') groups[t.date].esewaNet += t.amount;
            else groups[t.date].cashNet += t.amount;
        } else { // Expense
            groups[t.date].expense += t.amount;
            if(method === 'esewa') groups[t.date].esewaNet -= t.amount;
            else groups[t.date].cashNet -= t.amount;
        }
        // --- END FIX ---
        
        groups[t.date].transactions.push(t);
    });

    Object.keys(groups).sort((a,b) => new Date(b) - new Date(a)).forEach(date => {
        const d = groups[date];
        const net = d.income - d.expense;
        const tr = document.createElement('tr');
        
        // Updated table cells to match the new structure 
        tr.innerHTML = `
            <td>${date}</td>
            <td class="col-esewa">+Rs. ${d.income.toFixed(2)}</td>
            <td class="val-expense">-Rs. ${d.expense.toFixed(2)}</td>
            <td class="col-cash">${d.cashNet >= 0 ? '+' : ''}Rs. ${d.cashNet.toFixed(2)}</td>
            <td style="font-weight:bold; color: ${net >= 0 ? 'var(--accent-highlight)' : 'var(--accent-expense)'}">Rs. ${net.toFixed(2)}</td>
            <td class="no-print" style="font-size:0.85rem; text-align:right; padding-right:12px;">
                <a href="#" onclick="editTransactionFromReport('${date}'); event.stopPropagation();" style="color:var(--accent-highlight); margin-right:12px;">Edit</a>
                <a href="#" onclick="deleteDay('${date}'); event.stopPropagation();" style="color:var(--accent-expense);">Delete</a>
            </td>
        `;
        tr.addEventListener('click', () => window.openModal(date, d));
        list.appendChild(tr);
    });
}

window.openModal = (date, data) => {
    document.getElementById('modal-date-title').innerText = `Date: ${date}`;
    const body = document.getElementById('modal-transactions-body');
    body.innerHTML = ''; 
    let dayTotal = 0, cashFlow = 0, esewaFlow = 0;

    data.transactions.forEach(t => {
        const method = t.method || 'cash';
        const sign = t.type === 'expense' ? '-' : '+';
        const val = t.type === 'expense' ? -t.amount : t.amount;
        dayTotal += val;
        if(method === 'cash') cashFlow += val; else esewaFlow += val;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${t.text}</td>
            <td><span class="method-tag ${method === 'esewa' ? 'tag-esewa' : 'tag-cash'}">${method === 'esewa' ? 'eSewa' : 'Cash'}</span></td>
            <td style="text-align:right;"><span class="${t.type === 'income' ? 'val-income' : 'val-expense'}">${sign}Rs. ${Math.abs(t.amount).toFixed(2)}</span></td>
            <td class="no-print" style="text-align:right;">
                <a href="#" onclick="editTransaction('${t.id}'); event.stopPropagation();" style="text-decoration:none; font-size:1.2rem;">‚úèÔ∏è</a>
                <a href="#" onclick="deleteTransaction('${t.id}'); event.stopPropagation();" style="text-decoration:none; font-size:1.2rem; margin-left:10px;">üóëÔ∏è</a>
            </td>
        `;
        body.appendChild(tr);
    });

    document.getElementById('modal-total').innerText = `Rs. ${dayTotal.toFixed(2)}`;
    document.getElementById('modal-cash-total').innerText = `${cashFlow >= 0 ? '+' : ''}Rs. ${cashFlow.toFixed(2)}`;
    document.getElementById('modal-esewa-total').innerText = `${esewaFlow >= 0 ? '+' : ''}Rs. ${esewaFlow.toFixed(2)}`;
    modal.style.display = 'flex';
}

window.editTransactionFromReport = (date) => {
    const first = window.transactions.find(t => t.date === date);
    if (first) window.editTransaction(first.id);
}

window.closeModal = () => { modal.style.display = 'none'; document.body.classList.remove('printing-modal'); }
window.printModal = () => { document.body.classList.add('printing-modal'); window.print(); }
window.onclick = function(event) { if (event.target == modal) closeModal(); };

// FINAL EVENT LISTENERS
document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', (e) => window.switchTab(btn.getAttribute('onclick')?.match(/'([^']+)'/)?.[1] || btn.dataset.tab, e));
});
document.getElementById('date').addEventListener('input', () => window.updateDashboard());
</script>

<!-- FIREBASE MODULE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query } 
from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// YOUR FIREBASE KEYS
const firebaseConfig = {
  apiKey: "AIzaSyCqn4ka5C_GiPI-CY8aiWNTPXzVFcrr6D4",
  authDomain: "myshop-app-d5a54.firebaseapp.com",
  projectId: "myshop-app-d5a54",
  storageBucket: "myshop-app-d5a54.firebasestorage.app",
  messagingSenderId: "297951594734",
  appId: "1:297951594734:web:846dd5b3da1b60f4910bff"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const transactionsCollection = collection(db, "transactions");

// Form Elements
const form = document.getElementById('form');
const submitBtn = document.getElementById('submit-btn');
const textInput = document.getElementById('text');
const amountInput = document.getElementById('amount');
const typeInput = document.getElementById('type');
const methodInput = document.getElementById('method');
const dateInput = document.getElementById('date');
const loadingOverlay = document.getElementById('loading-overlay');

// REAL-TIME LISTENER
const q = query(transactionsCollection); 
onSnapshot(q, (snapshot) => {
    window.transactions = [];
    snapshot.docs.forEach(doc => {
        window.transactions.push({ ...doc.data(), id: doc.id });
    });
    
    window.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Call global UI functions
    window.updateDashboard();
    window.renderReports();
    loadingOverlay.style.display = 'none'; 
}, (error) => {
    console.error("Firebase Error:", error);
    loadingOverlay.innerHTML = `<div style="color:var(--accent-expense);">Sync Failed: ${error.code}</div>`;
});

// ADD/EDIT LOGIC
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (textInput.value.trim() === '' || amountInput.value.trim() === '') return;

    submitBtn.innerText = "‚è≥ Saving...";
    submitBtn.disabled = true;

    try {
        if (form.dataset.mode === 'edit') {
            const docRef = doc(db, "transactions", form.dataset.editId);
            await updateDoc(docRef, {
                date: dateInput.value,
                text: textInput.value,
                amount: +amountInput.value,
                type: typeInput.value,
                method: methodInput.value
            });
        } else {
            await addDoc(transactionsCollection, {
                text: textInput.value,
                amount: +amountInput.value,
                type: typeInput.value,
                method: methodInput.value, 
                date: dateInput.value
            });
        }

        // Reset
        textInput.value = '';
        amountInput.value = '';
        form.dataset.mode = 'add';
        form.dataset.editId = '';
        submitBtn.innerText = "‚úÖ Synced!";
        submitBtn.style.backgroundColor = 'var(--accent-esewa)';
        
        setTimeout(() => {
            submitBtn.innerText = "Add Transaction";
            submitBtn.disabled = false;
            submitBtn.style.backgroundColor = '';
        }, 1500);
        setTimeout(() => { textInput.focus(); }, 10);

    } catch (error) {
        console.error("Save Error:", error);
        alert("Error saving. Check console.");
        submitBtn.innerText = "Add Transaction";
        submitBtn.disabled = false;
    }
});

// EXPORT GLOBAL ACTIONS (Attached to window so HTML onclick works)
window.deleteTransaction = async (id) => {
    if (!confirm('Delete this transaction permanently?')) return;
    await deleteDoc(doc(db, "transactions", id));
}
window.deleteDay = async (date) => {
    if (!confirm('Delete ALL transactions for this date?')) return;
    const dayTrans = window.transactions.filter(t => t.date === date);
    dayTrans.forEach(async (t) => {
        await deleteDoc(doc(db, "transactions", t.id));
    });
    window.closeModal();
}
window.editTransaction = (id) => {
    const t = window.transactions.find(x => x.id === id);
    if (!t) return;
    window.closeModal();
    dateInput.value = t.date;
    textInput.value = t.text;
    amountInput.value = t.amount;
    typeInput.value = t.type;
    methodInput.value = t.method;
    form.dataset.mode = 'edit';
    form.dataset.editId = id;
    submitBtn.innerText = 'Update Cloud Transaction';
    window.switchTab('dashboard');
}
</script>
<script src="./renderer.js"></script>
</body>
</html>